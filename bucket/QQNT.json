{
    "version": "9.9.15.28327",
    "homepage": "https://im.qq.com/pcqq/index.shtml",
    "description": "(Beta version with LiteLoaderQQNT patch) An instant messaging software service developed by Tencent, build with Electron.",
    "license": {
        "identifier": "Proprietary",
        "url": "https://ti.qq.com/agreement/index.html"
    },
    "notes": "Scoop don't persist QQNT data.",
    "depends": [
        "LiteLoaderQQNT",
        "QQNTPatcher-DllHijack"
    ],
    "architecture": {
        "64bit": {
            "url": "https://dldir1.qq.com/qqfile/qq/QQNT/512caf78/QQ9.9.15.28327_x64.exe#/dl.7z",
            "hash": "6dc60f581891a282c6aae9e873a0b5555bc65eaa4f51d8779934ebd0bdb689a9"
        },
        "32bit": {
            "url": "https://dldir1.qq.com/qqfile/qq/QQNT/fe485b46/QQ9.9.15.28327_x86.exe#/dl.7z",
            "hash": "0f472dd8e466951095c3e8debef484628d7ba72c439d62368c04bce1610049b0"
        }
    },
    "extract_dir": "Files",
    "shortcuts": [
        [
            "QQ.exe",
            "QQ"
        ]
    ],
    "pre_install": [
        "Import-Module $(Join-Path $(Find-BucketDirectory -Root -Name air) scripts/AirUtils.psm1)",
        "# Patch with DllHijack",
        "$hijack_dir = scoop prefix 'QQNTPatcher-DllHijack'",
        "$arch = switch ($architecture) {",
        "    'arm64' { 'arm64' }",
        "    '64bit' { 'x64' }",
        "    default { 'x86' }",
        "}",
        "EnsureHardLink \"$dir\\dbghelp.dll\" \"$hijack_dir\\dbghelp_$arch.dll\"",
        "# Import LiteLoaderQQNT",
        "$version_text = $version -replace '(\\d+\\.\\d+\\.\\d+)\\.(\\d+)', '$1-$2'",
        "$patch_js = \"$dir\\versions\\$version_text\\resources\\app\\app_launcher\\patch.js\"",
        "$loader_dir = scoop prefix 'LiteLoaderQQNT'",
        "$patch_content = 'require(String.raw`' + $loader_dir + '`)'",
        "EnsureSetContent $patch_js $patch_content",
        "# Import package",
        "$package_json = \"$dir\\versions\\$version_text\\resources\\app\\package.json\"",
        "$json_object = Get-Content -Path $package_json -Raw | ConvertFrom-Json",
        "$json_object.main = \"./app_launcher/patch.js\"",
        "$updated_content = $json_object | ConvertTo-Json -Depth 100",
        "EnsureSetContent $package_json $updated_content",
        "Remove-Module -Name AirUtils"
    ],
    "checkver": {
        "script": [
            "$url = 'https://telemetr.io/en/channels/1606833156-qqupdates'",
            "$webContent = (Invoke-WebRequest -Uri $url).Content",
            "$x64Regex = 'https://dldir1\\.qq\\.com/qqfile/qq/QQNT/[\\da-z]+/QQ([\\d.]+)_x64\\.exe'",
            "$x86Regex = 'https://dldir1\\.qq\\.com/qqfile/qq/QQNT/[\\da-z]+/QQ([\\d.]+)_x86\\.exe'",
            "$arm64Regex = 'https://dldir1\\.qq\\.com/qqfile/qq/QQNT/[\\da-z]+/QQ([\\d.]+)_arm64\\.exe'",
            "$x64Match = [regex]::Match($webContent, $x64Regex)",
            "$x86Match = [regex]::Match($webContent, $x86Regex)",
            "$arm64Match = [regex]::Match($webContent, $arm64Regex)",
            "if ($x64Match.Success -and $x86Match.Success -and $arm64Match.Success) {",
            "    $version = $x64Match.Groups[1].Value",
            "    $x64Url = $x64Match.Groups[0].Value",
            "    $x86Url = $x86Match.Groups[0].Value",
            "    $arm64Url = $arm64Match.Groups[0].Value",
            "    $result = \"$version|$x64Url|$x86Url|$arm64Url\"",
            "    return $result",
            "}"
        ],
        "regex": "^(?<version>[\\d.]+)\\|(?<x64>.+)\\|(?<x86>.+)\\|(?<arm64>.+)$"
    },
    "autoupdate": {
        "architecture": {
            "64bit": {
                "url": "$matchX64#/dl.7z"
            },
            "32bit": {
                "url": "$matchX86#/dl.7z"
            }
        }
    }
}
